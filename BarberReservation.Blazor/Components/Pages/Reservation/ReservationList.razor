@page "/reservations/list"
@using BarberReservation.Shared.Models.Reservation

<PageTitle>Seznam rezervací</PageTitle>

@implements IDisposable
@inject MessageService MessageService
@inject IReservationService ReservationService
@inject NavigationManager Nav
@inject AuthState AuthState
@inject ILookUpsService LookUpsService
@inject IJSRuntime JS

@if (!_checked)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Načítám...</h1>
        <p class="page-subtitle muted">Chvilku strpení.</p>
    </div>
}
else
{
    <div class="container">
        <div class="page-head">
            <div class="row-between" style="margin:0;">
                <div>
                    @if (isAdmin)
                    {
                        <h1 class="page-title">Přehled všech rezervací</h1>
                        <p class="page-subtitle muted">Kompletní přehled a správa všech rezervací</p>
                    }
                    else
                    {
                        <h1 class="page-title">Moje rezervace</h1>
                        <p class="page-subtitle muted">Kompletní přehled mých rezervací</p>
                    }
                </div>

                <div class="header-actions">
                    <a class="btn btn-primary" href="/reservations/create">
                        + Vytvořit rezervaci
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="field">
                <label class="label" for="search">Hledat</label>

                <div class="input-row">
                    <div class="input-wrap">
                        <input id="search"
                               class="input input-has-clear"
                               value="@search"
                               @oninput="OnSearchInput"
                               placeholder="Služba, status..." />

                        @if (!string.IsNullOrWhiteSpace(search))
                        {
                            <button type="button" class="input-clear" @onclick="ClearSearchAsync">×</button>
                        }
                    </div>

                    <button class="btn btn-outline" type="button" @onclick="ApplyFiltersAsync" disabled="@isLoading">
                        Filtrovat
                    </button>
                </div>
            </div>

            <div class="row-between filters-row" style="align-items:flex-end;">
                @if (isAdmin || isCustomer)
                {
                    <div class="field" style="margin:0; min-width: 220px;">
                        <label class="label">Kadeřník</label>
                        <select class="input" disabled="@isLoading" @bind="hairdresserId" @bind:after="OnFiltersChangedAsync">
                            <option value="">Všichni</option>
                            @foreach (var hd in hairdressers)
                            {
                                <option value="@hd.Id">@hd.FullName</option>
                            }
                        </select>
                    </div>
                }

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Služba</label>
                    <select class="input" disabled="@isLoading" @bind="serviceId" @bind:after="OnFiltersChangedAsync">
                        <option value="">Všechny</option>
                        @foreach (var s in services)
                        {
                            <option value="@s.Id">@s.Name</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Status</label>
                    <select class="input" disabled="@isLoading" value="@status" @onchange="OnStatusChanged">
                        <option value="">Všechny</option>
                        @foreach (var rs in reservationStatuses)
                        {
                            <option value="@((ReservationStatus)rs.Value)">@rs.LabelCs</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Zrušeno (kým)</label>
                    <select class="input" disabled="@(!cancelFiltersEnabled || isLoading)" @bind="canceledBy" @bind:after="OnFiltersChangedAsync">
                        <option value="">Všichni</option>
                        @foreach (var cb in canceledByOptions)
                        {
                            <option value="@((ReservationCanceledBy)cb.Value)">@cb.LabelCs</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Důvod zrušení</label>
                    <select class="input" disabled="@(!cancelFiltersEnabled || isLoading)" @bind="canceledReason" @bind:after="OnFiltersChangedAsync">
                        <option value="">Všechny</option>
                        @foreach (var cr in canceledReasons)
                        {
                            <option value="@((CanceledReason)cr.Value)">@cr.LabelCs</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Řazení</label>
                    <select disabled="@isLoading" class="input" @bind="sortBy" @bind:after="OnFiltersChangedAsync">
                        <option value="">Vyberte možnost</option>
                        <option value="service">Služba</option>
                        <option value="status">Status</option>
                        <option value="createdat">Vytvořeno</option>
                        <option value="startat">Začátek</option>
                        <option value="canceledat">Zrušeno (kdy)</option>
                        @if (isAdmin || isCustomer)
                        {
                            <option value="hairdresser">Kadeřník</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 160px;">
                    <label class="label">Na stránku</label>
                    <select class="input" @bind="pageSize" @bind:after="OnFiltersChangedAsync">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 160px;">
                    <label class="label">&nbsp;</label>
                    <button class="btn btn-link" type="button" @onclick="ToggleSortAsync" disabled="@isLoading">
                        @((desc ? "↓ Sestupně" : "↑ Vzestupně"))
                    </button>
                </div>
            </div>

            <div class="row-between filters-row" style="align-items:flex-end; margin-top:14px;">
                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Vytvořeno od</label>
                    <input type="date" class="input" @bind="createdFrom" @bind:after="OnFiltersChangedAsync" />
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Vytvořeno do</label>
                    <input type="date" class="input" @bind="createdTo" @bind:after="OnFiltersChangedAsync" />
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Začátek od</label>
                    <input type="date" class="input" @bind="startFrom" @bind:after="OnFiltersChangedAsync" />
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label">Začátek do</label>
                    <input type="date" class="input" @bind="startTo" @bind:after="OnFiltersChangedAsync" />
                </div>

                <div class="field" style="margin:0; min-width: 220px; flex:0 0 220px;">
                    <label class="label">Zrušeno od</label>
                    <input type="date"
                           class="input"
                           disabled="@(!cancelFiltersEnabled || isLoading)"
                           value="@FormatDateForInput(canceledFrom)"
                           @onchange="OnCanceledFromChanged" />
                    @if (cancelFiltersEnabled && canceledFrom is not null)
                    {
                        <div class="muted" style="font-size:12px; margin-top:6px;">
                            @canceledFrom.Value.ToString("dd.MM.yyyy")
                        </div>
                    }
                </div>

                <div class="field" style="margin:0; min-width: 220px; flex:0 0 220px;">
                    <label class="label">Zrušeno do</label>
                    <input type="date"
                           class="input"
                           disabled="@(!cancelFiltersEnabled || isLoading)"
                           value="@FormatDateForInput(canceledTo)"
                           @onchange="OnCanceledToChanged" />
                    @if (cancelFiltersEnabled && canceledTo is not null)
                    {
                        <div class="muted" style="font-size:12px; margin-top:6px;">
                            @canceledTo.Value.ToString("dd.MM.yyyy")
                        </div>
                    }
                </div>

                <div class="field" style="margin:0 0 0 auto; min-width: 160px; flex:0 0 160px; text-align:right;">
                    <label class="label">&nbsp;</label>
                    <button class="btn btn-primary" type="button" @onclick="ResetFiltersAsync" disabled="@isLoading">
                        Zrušit filtry
                    </button>
                </div>
            </div>

            <div class="divider"></div>

            @if (isLoading)
            {
                <div class="muted center">Načítám rezervace...</div>
            }
            else if (!model.Items.Any())
            {
                <div class="muted center">Žádné rezervace nenalezeny.</div>
            }
            else
            {
                var showHairdresserCol = isAdmin || isCustomer;
                var showClientCol = isAdmin || isHairdresser;

                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom:1px solid var(--line);">
                                <th style="padding:10px 6px;">ID</th>

                                @if (showHairdresserCol)
                                {
                                    <th style="padding:10px 6px;">Kadeřník</th>
                                }

                                @if (showClientCol)
                                {
                                    <th style="padding:10px 6px;">Klient</th>
                                }

                                <th style="padding:10px 6px;">Služba</th>
                                <th style="padding:10px 6px;">Začátek</th>
                                <th style="padding:10px 6px;">Délka (minuty)</th>
                                <th style="padding:10px 6px;">Stav</th>
                                <th style="padding:10px 6px;"></th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var r in model.Items)
                            {
                                <tr style="border-bottom:1px solid var(--line);">
                                    <td style="padding:10px 6px;">@r.Id</td>

                                    @if (showHairdresserCol)
                                    {
                                        <td style="padding:10px 6px;">
                                            <span class="muted">@r.HairdresserFullName</span>
                                        </td>
                                    }

                                    @if (showClientCol)
                                    {
                                        <td style="padding:10px 6px;">
                                            @{
                                                var hasClient =
                                                !string.IsNullOrWhiteSpace(r.ClientFullName) ||
                                                !string.IsNullOrWhiteSpace(r.ClientEmail) ||
                                                !string.IsNullOrWhiteSpace(r.ClientPhone);
                                            }

                                            @if (!hasClient)
                                            {
                                                <span class="muted">—</span>
                                                @if (!string.IsNullOrWhiteSpace(r.CustomerId))
                                                {
                                                    <div class="muted" style="font-size:12px;">CustomerId: @r.CustomerId</div>
                                                }
                                            }
                                            else
                                            {
                                                <span>@(string.IsNullOrWhiteSpace(r.ClientFullName) ? "—" : r.ClientFullName)</span>

                                                @if (!string.IsNullOrWhiteSpace(r.ClientEmail) || !string.IsNullOrWhiteSpace(r.ClientPhone))
                                                {
                                                    <div class="muted" style="font-size:12px;">
                                                        @if (!string.IsNullOrWhiteSpace(r.ClientEmail))
                                                        {
                                                            <div>@r.ClientEmail</div>
                                                        }
                                                        @if (!string.IsNullOrWhiteSpace(r.ClientPhone))
                                                        {
                                                            <div>@r.ClientPhone</div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </td>
                                    }

                                    <td style="padding:10px 6px;">@r.ServiceName</td>

                                    <td style="padding:10px 6px;">
                                        <span class="muted">@r.StartAt.ToString("dd.MM.yyyy HH:mm")</span>
                                    </td>
                                    <td style="padding:10px 6px;">
                                        <span class="muted">@r.DurationMinutes</span>
                                    </td>

                                    <td style="padding:10px 6px;">
                                        <span class="muted">@Helper.GetCzechreservationStatus(r.Status)</span>
                                    </td>

                                    <td style="padding:10px 6px; text-align:right;">
                                        <div class="table-actions">
                                            @if (isAdmin || isHairdresser)
                                            {
                                                <button class="btn btn-mini btn-ghost"
                                                        type="button"
                                                        disabled="@(r.Status == ReservationStatus.Canceled)"
                                                        @onclick="() => ChangeReservationStatusAsync(r.Id)">
                                                    Změnit status
                                                </button>
                                            }
                                            @if (isCustomer && r.Status is not (ReservationStatus.Canceled or ReservationStatus.Paid or ReservationStatus.NoShow) && r.StartAt > DateTime.UtcNow.AddHours(24))
                                            {
                                                <button class="btn btn-mini btn-ghost" type="button" @onclick="() => CancelReservationAsync(r.Id)">
                                                    Zrušit rezervaci
                                                </button>
                                            }
                                            <a class="btn btn-link btn-mini" href="@($"/reservations/{r.Id}?returnUrl={Uri.EscapeDataString(BuildListUri())}")">Detail</a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="divider"></div>

                <div class="row-between" style="margin:0;">
                    <div class="muted">Celkem: @model.TotalItemsCount</div>
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-outline" type="button" @onclick="PrevPageAsync" disabled="@(isLoading || !model.CanGoPrevious)">
                            Předchozí
                        </button>

                        <span class="muted">@($"{page} / {model.TotalPages}")</span>

                        <button class="btn btn-outline" type="button" @onclick="NextPageAsync" disabled="@(isLoading || !model.CanGoNext)">
                            Další
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

<UiModal @bind-Open="showStatusModal"
         Title="Změna stavu rezervace"
         Subtitle="@statusModalSubtitle">

    <div class="field">
        <label class="label">Aktuální stav</label>
        <div class="input input-readonly">
            @Helper.GetCzechreservationStatus(statusModalCurrentStatus)
        </div>
    </div>

    <div class="field">
        <label class="label">Nový stav</label>
        <select class="input" disabled="@isLoading" @bind="statusModalNewStatus">
            @if (!isInFuture)
            {
                <option value="@ReservationStatus.Paid" disabled="@(statusModalCurrentStatus == ReservationStatus.Paid)">Zaplaceno</option>
                <option value="@ReservationStatus.NoShow" disabled="@(statusModalCurrentStatus == ReservationStatus.NoShow)">Klient se neukázal</option>
            }
            <option value="@ReservationStatus.Canceled" disabled="@(statusModalCurrentStatus == ReservationStatus.Canceled)">Zrušeno</option>

        </select>
    </div>

    @if (statusModalNewStatus == ReservationStatus.Canceled)
    {
        <div class="field">
            <label class="label">Důvod zrušení</label>
            <select class="input" disabled="@isLoading" @bind="statusModalCanceledReason">
                <option value="">Vyberte důvod</option>
                @foreach (var cr in canceledReasons)
                {
                    <option value="@((CanceledReason)cr.Value)">@cr.LabelCs</option>
                }
            </select>

            @if (statusReasonError is not null)
            {
                <div class="field-error">@statusReasonError</div>
            }
        </div>
    }

    <div class="ui-modal-foot">
        <button type="button" class="btn btn-outline" @onclick="CloseStatusModal" disabled="@isLoading">
            Zrušit
        </button>

        <button type="button" class="btn btn-primary" @onclick="ConfirmStatusChangeAsync" disabled="@(isLoading || statusModalNewStatus == statusModalCurrentStatus)">
            Uložit
        </button>
    </div>
</UiModal>


@code {
    [Parameter, SupplyParameterFromQuery(Name = "hairdresserId")]
    public string? HairdresserIdFromQuery { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "customerId")]
    public string? CustomerIdFromQuery { get; set; }

    private PagedResult<ReservationDto> model = new();
    private List<GetLookUpHairdressers> hairdressers = new();
    private List<ServiceLookUpDto> services = new();
    private List<EnumLookUpDto> reservationStatuses = new();
    private List<EnumLookUpDto> canceledByOptions = new();
    private List<EnumLookUpDto> canceledReasons = new();

    private bool _checked;
    private bool isLoading;
    private bool loaded;
    private bool locationSubscribed;
    private CancellationTokenSource? searchCts;
    private bool isAdmin;
    private bool isHairdresser;
    private bool isCustomer;

    private bool lookupsLoaded;
    bool cancelFiltersEnabled;

    private int page = 1;
    private int pageSize = 20;
    private int? serviceId;
    private string? hairdresserId;
    private string? customerId;
    private string? search;
    private string sortBy = "id";
    private bool desc;
    private ReservationStatus? status;
    private ReservationCanceledBy? canceledBy;
    private CanceledReason? canceledReason;
    private DateTime? createdFrom;
    private DateTime? createdTo;
    private DateTime? startFrom;
    private DateTime? startTo;
    private DateTime? canceledFrom;
    private DateTime? canceledTo;

    private bool showStatusModal;
    private bool isInFuture;

    private int statusModalReservationId;
    private ReservationStatus statusModalCurrentStatus;
    private ReservationStatus statusModalNewStatus;
    private CanceledReason? statusModalCanceledReason;

    private string? statusReasonError;
    private string statusModalSubtitle => statusModalReservationId > 0 ? $"Rezervace ID: {statusModalReservationId}" : "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || loaded)
            return;

        loaded = true;

        try
        {
            await AuthState.LoadAsync();

            if (!AuthState.IsAuthenticated)
            {
                _checked = true;
                Nav.NavigateTo("/", replace: true);
                await InvokeAsync(StateHasChanged);
                return;
            }

            _checked = true;
            await InvokeAsync(StateHasChanged);

            isAdmin = AuthState.Roles.Contains(nameof(UserRoles.Admin));
            isHairdresser = AuthState.Roles.Contains(nameof(UserRoles.Hairdresser));
            isCustomer = AuthState.Roles.Contains(nameof(UserRoles.Customer));

            if (!locationSubscribed)
            {
                locationSubscribed = true;
                Nav.LocationChanged += OnLocationChanged;
            }

            await EnsureLookupsAsync();

            ApplyQueryFromUrl();
            EnsureDefaultsIfMissing();

            await LoadAsync();
        }
        catch (ApiRequestException ex)
        {
            _checked = true;
            MessageService.ShowError(ex.Message);
            Nav.NavigateTo("/", replace: true);
        }
        catch (Exception ex)
        {
            _checked = true;
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task EnsureLookupsAsync()
    {
        if (lookupsLoaded)
            return;

        services = await LookUpsService.GetAllServicesAsync(CancellationToken.None);
        reservationStatuses = await LookUpsService.GetAllReservationStatusesAsync(CancellationToken.None);
        canceledByOptions = await LookUpsService.GetAllCanceledByOptionsAsync(CancellationToken.None);
        canceledReasons = await LookUpsService.GetAllCanceledReasonsAsync(CancellationToken.None);

        if (isAdmin || isCustomer)
            hairdressers = await LookUpsService.GetAllHairdressersAsync(CancellationToken.None);

        lookupsLoaded = true;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (!_checked)
            return;

        await InvokeAsync(async () =>
        {
            await EnsureLookupsAsync();
            ApplyQueryFromUrl();
            EnsureDefaultsIfMissing();
            await LoadAsync();
        });
    }

    private void ApplyQueryFromUrl()
    {
        var uri = new Uri(Nav.Uri);
        var q = QueryHelpers.ParseQuery(uri.Query);

        if (q.TryGetValue("page", out var qp) && int.TryParse(qp.ToString(), out var p) && p > 0)
            page = p;

        if (q.TryGetValue("pageSize", out var qps) && int.TryParse(qps.ToString(), out var ps) && ps > 0) 
            pageSize = ps;

        if (q.TryGetValue("search", out var qs)) 
            search = string.IsNullOrWhiteSpace(qs.ToString()) ? null : qs.ToString();

        if (q.TryGetValue("sortBy", out var qsb) && !string.IsNullOrWhiteSpace(qsb.ToString()))
            sortBy = qsb.ToString();

        if (q.TryGetValue("desc", out var qd) && bool.TryParse(qd.ToString(), out var d)) 
            desc = d;

        if (q.TryGetValue("serviceId", out var qsid) && int.TryParse(qsid.ToString(), out var sid)) 
            serviceId = sid;
        else 
            serviceId = null;

        if (q.TryGetValue("hairdresserId", out var qhid))
            hairdresserId = string.IsNullOrWhiteSpace(qhid.ToString()) ? null : qhid.ToString();

        if (q.TryGetValue("customerId", out var qcid))
            customerId = string.IsNullOrWhiteSpace(qcid.ToString()) ? null : qcid.ToString();

        if (q.TryGetValue("status", out var qst) && Enum.TryParse<ReservationStatus>(qst.ToString(), true, out var st)) 
            status = st;
        else 
            status = null;

        if (q.TryGetValue("canceledBy", out var qcb) && Enum.TryParse<ReservationCanceledBy>(qcb.ToString(), true, out var cb)) 
            canceledBy = cb;
        else 
            canceledBy = null;

        if (q.TryGetValue("canceledReason", out var qcr) && Enum.TryParse<CanceledReason>(qcr.ToString(), true, out var cr))
            canceledReason = cr;
        else 
            canceledReason = null;

        createdFrom = ParseDateFromInput(q.TryGetValue("createdFrom", out var cf) ? cf.ToString() : null);
        createdTo = ParseDateFromInput(q.TryGetValue("createdTo", out var ct) ? ct.ToString() : null);
        startFrom = ParseDateFromInput(q.TryGetValue("startFrom", out var sf) ? sf.ToString() : null);
        startTo = ParseDateFromInput(q.TryGetValue("startTo", out var stt) ? stt.ToString() : null);
        canceledFrom = ParseDateFromInput(q.TryGetValue("canceledFrom", out var caf) ? caf.ToString() : null);
        canceledTo = ParseDateFromInput(q.TryGetValue("canceledTo", out var cat) ? cat.ToString() : null);

        if (!isAdmin)
            customerId = null;

        if (!(isAdmin || isCustomer))
            hairdresserId = null;

        if (isAdmin && string.IsNullOrWhiteSpace(hairdresserId) && !string.IsNullOrWhiteSpace(HairdresserIdFromQuery))
        {
            hairdresserId = HairdresserIdFromQuery;
            customerId = null;
        }
        else if (isAdmin && string.IsNullOrWhiteSpace(customerId) && !string.IsNullOrWhiteSpace(CustomerIdFromQuery))
        {
            customerId = CustomerIdFromQuery;
            hairdresserId = null;
        }

        if (status != ReservationStatus.Canceled)
        {
            canceledBy = null;
            canceledReason = null;
            canceledFrom = null;
            canceledTo = null;
        }
    }

    private void EnsureDefaultsIfMissing()
    {
        if (createdFrom is null && createdTo is null && startFrom is null && startTo is null && canceledFrom is null && canceledTo is null)
            ApplyDefaultDates();

        if (string.IsNullOrWhiteSpace(sortBy))
            sortBy = "id";

        if (page <= 0)
            page = 1;

        if (pageSize <= 0)
            pageSize = 20;
    }

    private string BuildListUri(
        int? newPage = null,
        int? newPageSize = null,
        string? newSearch = null,
        int? newServiceId = null,
        string? newHairdresserId = null,
        string? newCustomerId = null,
        string? newSortBy = null,
        bool? newDesc = null,
        ReservationStatus? newStatus = null,
        ReservationCanceledBy? newCanceledBy = null,
        CanceledReason? newCanceledReason = null,
        DateTime? newCreatedFrom = null,
        DateTime? newCreatedTo = null,
        DateTime? newStartFrom = null,
        DateTime? newStartTo = null,
        DateTime? newCanceledFrom = null,
        DateTime? newCanceledTo = null)
    {
        var p = newPage ?? page;
        var ps = newPageSize ?? pageSize;

        var s = newSearch ?? search;
        var sid = newServiceId ?? serviceId;
        var hid = newHairdresserId ?? hairdresserId;
        var cid = newCustomerId ?? customerId;
        var sb = newSortBy ?? sortBy;
        var d = newDesc ?? desc;

        var st = newStatus ?? status;
        var cb = newCanceledBy ?? canceledBy;
        var cr = newCanceledReason ?? canceledReason;

        var cf = newCreatedFrom ?? createdFrom;
        var ct = newCreatedTo ?? createdTo;
        var sf = newStartFrom ?? startFrom;
        var stt = newStartTo ?? startTo;
        var caf = newCanceledFrom ?? canceledFrom;
        var cat = newCanceledTo ?? canceledTo;

        var parts = new List<string>
        {
            $"page={p}",
            $"pageSize={ps}",
            $"sortBy={Uri.EscapeDataString(string.IsNullOrWhiteSpace(sb) ? "id" : sb)}",
            $"desc={(d ? "true" : "false")}"
        };

        if (!string.IsNullOrWhiteSpace(s))
            parts.Add($"search={Uri.EscapeDataString(s.Trim())}");

        if (sid is not null)
            parts.Add($"serviceId={sid}");

        if ((isAdmin || isCustomer) && !string.IsNullOrWhiteSpace(hid))
            parts.Add($"hairdresserId={Uri.EscapeDataString(hid)}");

        if (isAdmin && !string.IsNullOrWhiteSpace(cid))
            parts.Add($"customerId={Uri.EscapeDataString(cid)}");

        if (st is not null)
            parts.Add($"status={Uri.EscapeDataString(st.ToString()!)}");

        if (st == ReservationStatus.Canceled)
        {
            if (cb is not null)
                parts.Add($"canceledBy={Uri.EscapeDataString(cb.ToString()!)}");

            if (cr is not null)
                parts.Add($"canceledReason={Uri.EscapeDataString(cr.ToString()!)}");

            if (caf is not null)
                parts.Add($"canceledFrom={Uri.EscapeDataString(caf.Value.ToString("yyyy-MM-dd"))}");

            if (cat is not null)
                parts.Add($"canceledTo={Uri.EscapeDataString(cat.Value.ToString("yyyy-MM-dd"))}");
        }

        if (cf is not null)
            parts.Add($"createdFrom={Uri.EscapeDataString(cf.Value.ToString("yyyy-MM-dd"))}");

        if (ct is not null)
            parts.Add($"createdTo={Uri.EscapeDataString(ct.Value.ToString("yyyy-MM-dd"))}");

        if (sf is not null)
            parts.Add($"startFrom={Uri.EscapeDataString(sf.Value.ToString("yyyy-MM-dd"))}");

        if (stt is not null)
            parts.Add($"startTo={Uri.EscapeDataString(stt.Value.ToString("yyyy-MM-dd"))}");

        return $"/reservations/list?{string.Join("&", parts)}";
    }

    private void NavigateToState(
        int? newPage = null,
        int? newPageSize = null,
        string? newSearch = null,
        int? newServiceId = null,
        string? newHairdresserId = null,
        string? newCustomerId = null,
        string? newSortBy = null,
        bool? newDesc = null,
        ReservationStatus? newStatus = null,
        ReservationCanceledBy? newCanceledBy = null,
        CanceledReason? newCanceledReason = null,
        DateTime? newCreatedFrom = null,
        DateTime? newCreatedTo = null,
        DateTime? newStartFrom = null,
        DateTime? newStartTo = null,
        DateTime? newCanceledFrom = null,
        DateTime? newCanceledTo = null,
        bool replace = true)
    {
        var url = BuildListUri(
            newPage, newPageSize, newSearch, newServiceId, newHairdresserId, newCustomerId,
            newSortBy, newDesc, newStatus, newCanceledBy, newCanceledReason,
            newCreatedFrom, newCreatedTo, newStartFrom, newStartTo, newCanceledFrom, newCanceledTo);

        Nav.NavigateTo(url, replace: replace);
    }

    private async Task LoadAsync()
    {
        isLoading = true;

        cancelFiltersEnabled = status == ReservationStatus.Canceled;

        try
        {
            var req = new ReservationPagedRequest
            {
                Page = page,
                PageSize = pageSize,
                Search = string.IsNullOrWhiteSpace(search) ? null : search.Trim(),
                SortBy = sortBy,
                Desc = desc,
                ServiceId = serviceId,
                HairdresserId = (isAdmin || isCustomer) ? hairdresserId : null,
                CustomerId = isAdmin ? customerId : null,
                Status = status,
                CanceledBy = canceledBy,
                CanceledReason = canceledReason,
                CreatedFrom = createdFrom,
                CreatedTo = createdTo,
                StartFrom = startFrom,
                StartTo = startTo,
                CanceledFrom = status == ReservationStatus.Canceled ? canceledFrom : null,
                CanceledTo = status == ReservationStatus.Canceled ? canceledTo : null
            };

            model = await ReservationService.GetAllAsync(req, CancellationToken.None);

            if (model is not null)
            {
                page = model.Page;
                pageSize = model.PageSize;
            }
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task ApplyFiltersAsync()
    {
        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private Task ToggleSortAsync()
    {
        NavigateToState(newPage: 1, newDesc: !desc, replace: true);
        return Task.CompletedTask;
    }

    private Task PrevPageAsync()
    {
        if (!model.CanGoPrevious)
            return Task.CompletedTask;

        NavigateToState(newPage: page - 1, replace: true);
        return Task.CompletedTask;
    }

    private Task NextPageAsync()
    {
        if (!model.CanGoNext)
            return Task.CompletedTask;

        NavigateToState(newPage: page + 1, replace: true);
        return Task.CompletedTask;
    }

    private Task ClearSearchAsync()
    {
        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = null;

        search = "";
        NavigateToState(newPage: 1, newSearch: null, replace: true);
        return Task.CompletedTask;
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? "";
        search = newValue;
        page = 1;

        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = new CancellationTokenSource();
        var token = searchCts.Token;

        try
        {
            await Task.Delay(350, token);
            if (token.IsCancellationRequested)
                return;

            var snapshot = newValue;

            NavigateToState(
                newPage: 1,
                newSearch: string.IsNullOrWhiteSpace(snapshot) ? null : snapshot,
                replace: true);
        }
        catch (TaskCanceledException)
        {
        }
    }

    private Task OnFiltersChangedAsync()
    {
        if (status != ReservationStatus.Canceled)
        {
            canceledBy = null;
            canceledReason = null;
            canceledFrom = null;
            canceledTo = null;
        }

        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private Task OnStatusChanged(ChangeEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(e.Value?.ToString()))
            status = null;
        else
            status = Enum.Parse<ReservationStatus>(e.Value!.ToString()!, ignoreCase: true);

        if (status != ReservationStatus.Canceled)
        {
            canceledBy = null;
            canceledReason = null;
            canceledFrom = null;
            canceledTo = null;
        }

        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private static string FormatDateForInput(DateTime? value)
    {
        return value is null ? "" : value.Value.ToString("yyyy-MM-dd");
    }

    private Task OnCanceledFromChanged(ChangeEventArgs e)
    {
        canceledFrom = ParseDateFromInput(e.Value?.ToString());
        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private Task OnCanceledToChanged(ChangeEventArgs e)
    {
        canceledTo = ParseDateFromInput(e.Value?.ToString());
        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private static DateTime? ParseDateFromInput(string? value)
    {
        return DateTime.TryParse(value, out var dt) ? dt.Date : null;
    }

    private void ApplyDefaultDates()
    {
        var from = DateTime.Today.AddYears(-1);
        var to = DateTime.Today.AddYears(1);

        createdFrom = from;
        createdTo = to;

        startFrom = from;
        startTo = to;

        canceledFrom = from;
        canceledTo = to;
    }

    private Task ResetFiltersAsync()
    {
        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = null;

        page = 1;
        pageSize = 20;
        sortBy = "id";
        desc = false;

        serviceId = null;
        hairdresserId = null;
        customerId = null;
        status = null;
        canceledBy = null;
        canceledReason = null;

        ApplyDefaultDates();
        search = null;

        NavigateToState(
            newPage: 1,
            newPageSize: 20,
            newSearch: null,
            newServiceId: null,
            newHairdresserId: null,
            newCustomerId: null,
            newSortBy: "id",
            newDesc: false,
            newStatus: null,
            newCanceledBy: null,
            newCanceledReason: null,
            newCreatedFrom: createdFrom,
            newCreatedTo: createdTo,
            newStartFrom: startFrom,
            newStartTo: startTo,
            newCanceledFrom: null,
            newCanceledTo: null,
            replace: true);

        return Task.CompletedTask;
    }

    private async Task CancelReservationAsync(int id)
    {
        var ok = await JS.ConfirmAction($"Opravdu chcete zrušit rezervaci {id} ?");

        if (!ok)
            return;

        isLoading = true;

        try
        {
            await ReservationService.CancelReservationByClientAsync(id, CancellationToken.None);
            await LoadAsync();
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task ChangeReservationStatusAsync(int id)
    {
        var row = model.Items.FirstOrDefault(x => x.Id == id);
        if (row is null)
            return Task.CompletedTask;

        isInFuture = row.StartAt > DateTime.UtcNow;

        statusModalReservationId = id;
        statusModalCurrentStatus = row.Status;

        if (isInFuture)
        {
            statusModalNewStatus = ReservationStatus.Canceled;
        }
        else
        {
            statusModalNewStatus =
                statusModalCurrentStatus != ReservationStatus.Paid ? ReservationStatus.Paid :
                statusModalCurrentStatus != ReservationStatus.NoShow ? ReservationStatus.NoShow :
                ReservationStatus.Canceled;
        }

        statusModalCanceledReason = null;
        statusReasonError = null;
        showStatusModal = true;

        return Task.CompletedTask;
    }

    private void CloseStatusModal()
    {
        showStatusModal = false;
        statusReasonError = null;
    }

    private async Task ConfirmStatusChangeAsync()
    {
        statusReasonError = null;

        if (statusModalNewStatus == ReservationStatus.Canceled && statusModalCanceledReason is null)
        {
            statusReasonError = "Vyberte důvod zrušení.";
            await InvokeAsync(StateHasChanged);
            return;
        }

        var ok = await JS.ConfirmAction($"Opravdu chcete změnit stav rezervace {statusModalReservationId} na '{Helper.GetCzechreservationStatus(statusModalNewStatus)}'?");

        if (!ok)
            return;

        isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var req = new UpdateReservationStatusRequest
            {
                NewReservationStatus = statusModalNewStatus,
                CanceledReason = statusModalNewStatus == ReservationStatus.Canceled ? statusModalCanceledReason : null
            };

            await ReservationService.UpdateStatusAsync(statusModalReservationId, req, CancellationToken.None);

            MessageService.ShowSuccess("Stav rezervace byl změněn.");
            showStatusModal = false;

            await LoadAsync();
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (locationSubscribed)
        {
            locationSubscribed = false;
            Nav.LocationChanged -= OnLocationChanged;
        }

        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = null;
    }
}
