@page "/change-password"

@inject IAuthService AuthService
@inject AuthState AuthState
@inject NavigationManager Nav
@inject MessageService MessageService
@inject AuthenticationStateProvider AuthenticationStateProvider


<div class="page-head page-head-center">
    <h1 class="page-title">Změna hesla</h1>
    <p class="page-subtitle muted">Nejprve si nastavte nové heslo.</p>
</div>

<div class="stack-top">
    <div class="card card-md">
        <EditForm Model="_model" OnValidSubmit="HandleChangePasswordAsync">
            <DataAnnotationsValidator />

            <div class="field">
                <label class="label" for="old">Staré heslo</label>
                <InputText id="old"
                           class="input"
                           type="@(_showOld ? "text" : "password")"
                           @bind-Value="_model.OldPassword"
                           autocomplete="current-password"
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => _model.OldPassword)" class="field-error" />
            </div>

            <div class="field">
                <label class="label" for="new">Nové heslo</label>
                <InputText id="new"
                           class="input"
                           type="@(_showNew ? "text" : "password")"
                           @bind-Value="_model.NewPassword"
                           autocomplete="new-password"
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => _model.NewPassword)" class="field-error" />
            </div>

            <div class="field">
                <label class="label" for="confirm">Potvrdit nové heslo</label>
                <InputText id="confirm"
                           class="input"
                           type="@(_showConfirm ? "text" : "password")"
                           @bind-Value="_model.ConfirmPassword"
                           autocomplete="new-password"
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => _model.ConfirmPassword)" class="field-error" />
            </div>

            <div class="row-between">
                <label class="check">
                    <InputCheckbox class="checkbox" @bind-Value="_showAll" />
                    <span>Zobrazit hesla</span>
                </label>
            </div>

            <button class="btn btn-primary btn-block" type="submit" disabled="@_isSubmitting">
                @(_isSubmitting ? "Ukládám..." : "Změnit heslo")
            </button>
        </EditForm>
    </div>
</div>

@code {
    private readonly ChangePasswordRequest _model = new();
    private bool _isSubmitting;
    private bool _checked;
    private bool _showAllBacking;
    private string? _returnUrl;

    private bool _showOld;
    private bool _showNew;
    private bool _showConfirm;

    private bool _showAll
    {
        get => _showAllBacking;
        set
        {
            _showAllBacking = value;
            _showOld = value;
            _showNew = value;
            _showConfirm = value;
        }
    }

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        _returnUrl = query.TryGetValue("returnUrl", out var v) ? v.ToString() : null;

        if (AuthState.IsAuthenticated)
        {
            if (AuthState.MustChangePassword)
                Nav.NavigateTo("/change-password", replace: true);
            else
                Nav.NavigateTo("/", replace: true);
        }
    }

    private async Task HandleChangePasswordAsync()
    {
        _isSubmitting = true;

        try
        {
            await AuthService.ChangePasswordAsync(_model, CancellationToken.None);

            await AuthState.MarkPasswordChangedAsync();
            MessageService.ShowSuccess("Heslo bylo změněno.");
            Nav.NavigateTo("/", replace: true);
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
