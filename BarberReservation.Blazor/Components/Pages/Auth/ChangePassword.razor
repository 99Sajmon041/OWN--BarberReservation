@page "/change-password"

@inject IAuthService AuthService
@inject AuthState AuthState
@inject NavigationManager Nav
@inject MessageService MessageService

@if (!_checked)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Načítám...</h1>
        <p class="page-subtitle muted">Chvilku strpení.</p>
    </div>
}
else
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Změna hesla</h1>
        <p class="page-subtitle muted">Nejprve si nastavte nové heslo.</p>
    </div>

    <div class="stack-top">
        <div class="card card-md">
            <EditForm Model="request" OnValidSubmit="HandleChangePasswordAsync">
                <DataAnnotationsValidator />

                <div class="field">
                    <label class="label" for="old">Staré heslo</label>
                    <InputText id="old"
                               class="input"
                               type="@(showOld ? "text" : "password")"
                               @bind-Value="request.OldPassword"
                               autocomplete="current-password"
                               placeholder="••••••••" />
                    <ValidationMessage For="@(() => request.OldPassword)" class="field-error" />
                </div>

                <div class="field">
                    <label class="label" for="new">Nové heslo</label>
                    <InputText id="new"
                               class="input"
                               type="@(showNew ? "text" : "password")"
                               @bind-Value="request.NewPassword"
                               autocomplete="new-password"
                               placeholder="••••••••" />
                    <ValidationMessage For="@(() => request.NewPassword)" class="field-error" />
                </div>

                <div class="field">
                    <label class="label" for="confirm">Potvrdit nové heslo</label>
                    <InputText id="confirm"
                               class="input"
                               type="@(showConfirm ? "text" : "password")"
                               @bind-Value="request.ConfirmPassword"
                               autocomplete="new-password"
                               placeholder="••••••••" />
                    <ValidationMessage For="@(() => request.ConfirmPassword)" class="field-error" />
                </div>

                <div class="row-between">
                    <label class="check">
                        <InputCheckbox class="checkbox" @bind-Value="showAll" />
                        <span>Zobrazit hesla</span>
                    </label>
                </div>

                <button class="btn btn-primary btn-block" type="submit" disabled="@isSubmitting">
                    @(isSubmitting ? "Ukládám..." : "Změnit heslo")
                </button>
            </EditForm>
        </div>
    </div>
}

@code {
    private readonly ChangePasswordRequest request = new();

    private bool isSubmitting;

    private bool _checked;
    private bool _loaded;
    private string? _returnUrl;

    private bool showAllBacking;
    private bool showOld;
    private bool showNew;
    private bool showConfirm;

    private bool showAll
    {
        get => showAllBacking;
        set
        {
            showAllBacking = value;
            showOld = value;
            showNew = value;
            showConfirm = value;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded)
            return;

        _loaded = true;

        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        _returnUrl = query.TryGetValue("returnUrl", out var v) ? v.ToString() : null;

        await AuthState.LoadAsync();

        if (!AuthState.IsAuthenticated)
        {
            StateHasChanged();
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/change-password")}", replace: true);
            return;
        }

        // if (!AuthState.MustChangePassword)
        // {
        //     StateHasChanged();
        //     Nav.NavigateTo(SafeReturnUrl(_returnUrl), replace: true);
        //     return;
        // }

        _checked = true;
        StateHasChanged();
    }

    private async Task HandleChangePasswordAsync()
    {
        isSubmitting = true;

        try
        {
            await AuthService.ChangePasswordAsync(request, CancellationToken.None);
            await AuthState.MarkPasswordChangedAsync();

            MessageService.ShowSuccess("Heslo bylo změněno.");
            Nav.NavigateTo(SafeReturnUrl(_returnUrl), replace: true);
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private static string SafeReturnUrl(string? returnUrl)
    {
        if (string.IsNullOrWhiteSpace(returnUrl))
            return "/";

        if (returnUrl.StartsWith("/") && !returnUrl.StartsWith("//"))
            return returnUrl;

        return "/";
    }
}
