@page "/reset-password"

@inject MessageService MessageService
@inject IAuthService AuthService
@inject AuthState AuthState
@inject NavigationManager Nav

@if (!_checked)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Načítám...</h1>
        <p class="page-subtitle muted">Chvilku strpení.</p>
    </div>
}
else if (invalidLink)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Neplatný odkaz</h1>
        <p class="page-subtitle muted">Odkaz pro obnovu hesla je neplatný nebo vypršel.</p>
    </div>

    <div class="stack-top">
        <div class="card card-md">
            <div class="center muted">
                Zkuste si nechat poslat nový odkaz.
            </div>

            <div class="divider"></div>

            <div class="row-between">
                <a class="link" href="/forgot-password">Poslat nový odkaz</a>
                <a class="link" href="/login">Zpět na přihlášení</a>
            </div>
        </div>
    </div>
}
else if(!redirecting)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Obnova hesla</h1>
        <p class="page-subtitle muted">Nastavte si nové heslo.</p>
    </div>

    <div class="stack-top">
        <div class="card card-md">
            <EditForm Model="request" OnValidSubmit="HandleResetPasswordAsync">
                <DataAnnotationsValidator />

                <div class="field">
                    <label class="label" for="newPassword">Nové heslo</label>
                    <InputText id="newPassword"
                               class="input"
                               type="@(showNew ? "text" : "password")"
                               @bind-Value="request.NewPassword"
                               autocomplete="new-password"
                               placeholder="••••••••" />
                    <ValidationMessage For="@(() => request.NewPassword)" class="field-error" />
                </div>
                <div class="field">
                    <label class="label" for="confirmPassword">Potvrzení nového hesla</label>
                    <InputText id="confirmPassword"
                               class="input"
                               type="@(showConfirm ? "text" : "password")"
                               @bind-Value="request.ConfirmPassword"
                               autocomplete="confirm-password"
                               placeholder="••••••••" />
                    <ValidationMessage For="@(() => request.ConfirmPassword)" class="field-error" />
                </div>

                <div class="row-between">
                    <label class="check">
                        <InputCheckbox class="checkbox" @bind-Value="showAll" />
                        <span>Zobrazit hesla</span>
                    </label>
                </div>

                <button class="btn btn-primary btn-block" type="submit" disabled="@isSubmitting">
                    @(isSubmitting ? "Odesílám..." : "Odeslat")
                </button>
            </EditForm>
        </div>
    </div>
}


@code {
    ResetPasswordRequest request = new();

    private bool invalidLink;
    private bool isSubmitting;
    private bool redirecting;
    private bool _checked;

    private bool showAllBacking;
    private bool showNew;
    private bool showConfirm;

    private bool showAll
    {
        get => showAllBacking;
        set
        {
            showAllBacking = value;
            showNew = value;
            showConfirm = value;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await AuthState.LoadAsync();

        if (AuthState.IsAuthenticated)
        {
            redirecting = true;
            StateHasChanged();
            Nav.NavigateTo("/", replace: true);
            return;
        }

        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("email", out var email))
            request.Email = email!;

        if (query.TryGetValue("token", out var token))
            request.Token = token!;


        if (string.IsNullOrWhiteSpace(request.Email) || string.IsNullOrWhiteSpace(request.Token))
        {
            invalidLink = true;
            MessageService.ShowError("Odkaz pro reset hesla je neplatný nebo vypršel.");
        }

        _checked = true;
        StateHasChanged();
    }

    private async Task HandleResetPasswordAsync()
    {
        isSubmitting = true;

        try
        {
            await AuthService.ResetPasswordAsync(request, CancellationToken.None); 
            MessageService.ShowSuccess("Změna hesla proběhla úspěšně.");
            Nav.NavigateTo("/login", replace: true);
        }
        catch(ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
