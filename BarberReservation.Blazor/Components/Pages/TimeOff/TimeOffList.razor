@page "/time-off/list"

<PageTitle>Volna</PageTitle>

@implements IDisposable
@inject MessageService MessageService
@inject ITimeOffService TimeOffService
@inject NavigationManager Nav
@inject AuthState AuthState
@inject ILookUpsService LookUpsService

@if (!_checked)
{
    <div class="page-head page-head-center">
        <h1 class="page-title">Načítám...</h1>
        <p class="page-subtitle muted">Chvilku strpení.</p>
    </div>
}
else
{
    <div class="container">
        <div class="page-head">
            <div class="row-between" style="margin:0;">
                <div>
                    @if (isAdmin)
                    {
                        <h1 class="page-title">Volna kadeřníků</h1>
                        <p class="page-subtitle muted">Přehled voln všech kadeřníků</p>
                    }
                    else
                    {
                        <h1 class="page-title">Moje volna</h1>
                        <p class="page-subtitle muted">Přehled mých voln</p>
                    }
                </div>

                <div class="header-actions">
                    <a class="btn btn-primary" href="/time-off/detail">
                        správa / vytvoření volna
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="field">
                <label class="label" for="search">Hledat</label>

                <div class="input-row">
                    <div class="input-wrap">
                        <input id="search"
                               class="input input-has-clear"
                               value="@search"
                               @oninput="OnSearchInput"
                               placeholder="Název..." />

                        @if (!string.IsNullOrWhiteSpace(search))
                        {
                            <button type="button" class="input-clear" @onclick="ClearSearchAsync" aria-label="Vyčistit hledání">
                                ×
                            </button>
                        }
                    </div>

                    <button class="btn btn-outline" type="button" @onclick="ApplyFiltersAsync" disabled="@isLoading">
                        Filtrovat
                    </button>
                </div>
            </div>

            <div class="row-between filters-row">
                @if (isAdmin)
                {
                    <div class="field" style="margin:0; min-width: 220px;">
                        <label class="label" for="hairdresserId">Kadeřník</label>
                        <select id="hairdresserId" class="input" disabled="@isLoading" @bind="hairdresserId" @bind:after="OnFiltersChangedAsync">
                            <option value="">Všichni</option>
                            @foreach (var hd in hairdressers)
                            {
                                <option value="@hd.Id">@hd.FullName</option>
                            }
                        </select>
                    </div>
                }

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label" for="year">Rok</label>
                    <select id="year" class="input" disabled="@isLoading" @bind="year" @bind:after="OnFiltersChangedAsync">
                        <option value="">Všechny</option>
                        @for (int i = CurrentYear; i <= CurrentYear + 20; i++)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 220px;">
                    <label class="label" for="month">Měsíc</label>
                    <select id="month" class="input" disabled="@(isLoading || year is null)" @bind="month" @bind:after="OnFiltersChangedAsync">
                        <option value="">Všechny</option>
                        @for (int i = 1; i <= 12; i++)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                </div>

                @if (isAdmin)
                {
                    <div class="field" style="margin:0; min-width: 220px;">
                        <label class="label" for="sortBy">Řazení</label>
                        <select id="sortBy" disabled="@isLoading" class="input" @bind="sortBy" @bind:after="OnFiltersChangedAsync">
                            <option value="startdate">Datum</option>
                            <option value="hairdresser">Kadeřník</option>
                        </select>
                    </div>
                }

                <div class="field" style="margin:0; min-width: 160px;">
                    <label class="label" for="pageSize">Na stránku</label>
                    <select id="pageSize" class="input" @bind="pageSize" @bind:after="OnFiltersChangedAsync">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>

                <div class="field" style="margin:0; min-width: 160px;">
                    <label class="label">&nbsp;</label>
                    <button class="btn btn-link" type="button" @onclick="ToggleSortAsync" disabled="@isLoading">
                        @((desc ? "↓ Sestupně" : "↑ Vzestupně"))
                    </button>
                </div>
            </div>

            <div class="divider"></div>

            @if (isLoading)
            {
                <div class="muted center">Načítám volna...</div>
            }
            else if (model is null || model.Items is null || !model.Items.Any())
            {
                <div class="muted center">Žádné volna nenalezeny.</div>
            }
            else
            {
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom: 1px solid var(--line);">
                                <th style="padding: 10px 6px;">ID</th>
                                @if (isAdmin)
                                {
                                    <th style="padding: 10px 6px;"><a>Jméno kadeřníka</a></th>
                                }
                                <th style="padding: 10px 6px;">Den (datum)</th>
                                <th style="padding: 10px 6px;">Začátek volna</th>
                                <th style="padding: 10px 6px;">Konec volna</th>
                                <th style="padding: 10px 6px;">Důvod volna</th>
                                <th style="padding: 10px 6px;">Vytvořeno</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var to in model.Items)
                            {
                                <tr style="border-bottom: 1px solid var(--line);">
                                    <td style="padding: 10px 6px;">
                                        @to.Id
                                    </td>
                                    @if (isAdmin)
                                    {
                                        <td style="padding: 10px 6px;">
                                            <a class="link-chip" href="/users/@to.HairdresserId">
                                                @to.HairdresserName
                                                <span class="link-chip-icon">↗</span>
                                            </a>
                                        </td>
                                    }
                                    <td style="padding: 10px 6px;">
                                        <span class="muted">@to.StartAt.ToString("dd.MM.yyyy")</span>
                                    </td>
                                    <td style="padding: 10px 6px;">
                                        <span class="muted">@to.StartAt.ToString("HH:mm")</span>
                                    </td>
                                    <td style="padding: 10px 6px;">
                                        <span class="muted">@to.EndAt.ToString("HH:mm")</span>
                                    </td>
                                    <td style="padding: 10px 6px;">
                                        <span class="muted">@to.Reason</span>
                                    </td>
                                    <td style="padding: 10px 6px;">
                                        <span class="muted">@to.CreatedAt.ToString("dd.MM.yyyy - HH:mm")</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="divider"></div>

                <div class="row-between" style="margin:0;">
                    <div class="muted">
                        Celkem: @model.TotalItemsCount
                    </div>

                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-outline" type="button" @onclick="PrevPageAsync" disabled="@(isLoading || !model.CanGoPrevious)">
                            Předchozí
                        </button>

                        <span class="muted">@($"Strana: {page} / {model.TotalPages}")</span>

                        <button class="btn btn-outline" type="button" @onclick="NextPageAsync" disabled="@(isLoading || !model.CanGoNext)">
                            Další
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter, SupplyParameterFromQuery(Name = "hairdresserId")]
    public string? HairdresserIdQuery { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "year")]
    public int? YearQuery { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "month")]
    public int? MonthQuery { get; set; }

    private PagedResult<HairdresserTimeOffDto> model = new();
    private List<GetLookUpHairdressers> hairdressers = new();

    private bool _checked;
    private bool isLoading;
    private bool loaded;
    private bool locationSubscribed;
    private CancellationTokenSource? searchCts;
    private bool isAdmin;
    private bool lookupsLoaded;

    private int page = 1;
    private int pageSize = 20;
    private string? hairdresserId;
    private int? year;
    private int? month;

    private string? search;
    private string sortBy = "startdate";
    private bool desc;

    private int CurrentYear => DateTime.Today.Year;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || loaded)
            return;

        loaded = true;

        try
        {
            await AuthState.LoadAsync();

            if (!AuthState.IsAuthenticated || (!AuthState.Roles.Contains(nameof(UserRoles.Hairdresser)) && !AuthState.Roles.Contains(nameof(UserRoles.Admin))))
            {
                _checked = true;
                Nav.NavigateTo("/", replace: true);
                await InvokeAsync(StateHasChanged);
                return;
            }

            _checked = true;
            await InvokeAsync(StateHasChanged);

            isAdmin = AuthState.Roles.Contains(nameof(UserRoles.Admin));

            if (!locationSubscribed)
            {
                locationSubscribed = true;
                Nav.LocationChanged += OnLocationChanged;
            }

            await EnsureLookupsAsync();

            ApplyQueryFromUrl();
            await LoadAsync();
        }
        catch (ApiRequestException ex)
        {
            _checked = true;
            MessageService.ShowError(ex.Message);
            Nav.NavigateTo("/", replace: true);
        }
        catch (Exception ex)
        {
            _checked = true;
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task EnsureLookupsAsync()
    {
        if (lookupsLoaded)
            return;

        if (isAdmin)
            hairdressers = await LookUpsService.GetAllHairdressersAsync(CancellationToken.None);

        lookupsLoaded = true;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (!_checked)
            return;

        await InvokeAsync(async () =>
        {
            await EnsureLookupsAsync();
            ApplyQueryFromUrl();
            await LoadAsync();
        });
    }

    private void ApplyQueryFromUrl()
    {
        var uri = new Uri(Nav.Uri);
        var q = QueryHelpers.ParseQuery(uri.Query);

        if (q.TryGetValue("page", out var qp) && int.TryParse(qp.ToString(), out var p) && p > 0)
            page = p;

        if (q.TryGetValue("pageSize", out var qps) && int.TryParse(qps.ToString(), out var ps) && ps > 0)
            pageSize = ps;

        if (q.TryGetValue("search", out var qs))
            search = string.IsNullOrWhiteSpace(qs.ToString()) ? null : qs.ToString();

        if (q.TryGetValue("sortBy", out var qsb) && !string.IsNullOrWhiteSpace(qsb.ToString()))
            sortBy = qsb.ToString();

        if (q.TryGetValue("desc", out var qd) && bool.TryParse(qd.ToString(), out var d))
            desc = d;

        if (q.TryGetValue("year", out var qy) && int.TryParse(qy.ToString(), out var yy))
            year = yy;
        else year = YearQuery;

        if (q.TryGetValue("month", out var qm) && int.TryParse(qm.ToString(), out var mm))
            month = mm;
        else month = MonthQuery;

        if (year is null)
            month = null;

        if (isAdmin)
        {
            if (q.TryGetValue("hairdresserId", out var qhid))
                hairdresserId = string.IsNullOrWhiteSpace(qhid.ToString()) ? null : qhid.ToString();
            else
                hairdresserId = HairdresserIdQuery;
        }
        else
        {
            hairdresserId = null;
        }
    }

    private string BuildListUri(
        int? newPage = null,
        int? newPageSize = null,
        string? newSearch = null,
        string? newHairdresserId = null,
        int? newYear = null,
        int? newMonth = null,
        string? newSortBy = null,
        bool? newDesc = null)
    {
        var p = newPage ?? page;
        var ps = newPageSize ?? pageSize;
        var s = newSearch ?? search;
        var hid = newHairdresserId ?? hairdresserId;
        var y = newYear ?? year;
        var m = newMonth ?? month;
        var sb = newSortBy ?? sortBy;
        var d = newDesc ?? desc;

        var parts = new List<string>
        {
            $"page={p}",
            $"pageSize={ps}",
            $"sortBy={Uri.EscapeDataString(sb)}",
            $"desc={(d ? "true" : "false")}"
        };

        if (!string.IsNullOrWhiteSpace(s))
            parts.Add($"search={Uri.EscapeDataString(s.Trim())}");

        if (isAdmin && !string.IsNullOrWhiteSpace(hid))
            parts.Add($"hairdresserId={Uri.EscapeDataString(hid)}");

        if (y is not null)
            parts.Add($"year={y}");

        if (y is not null && m is not null)
            parts.Add($"month={m}");

        return $"/time-off/list?{string.Join("&", parts)}";
    }

    private void NavigateToState(
        int? newPage = null,
        int? newPageSize = null,
        string? newSearch = null,
        string? newHairdresserId = null,
        int? newYear = null,
        int? newMonth = null,
        string? newSortBy = null,
        bool? newDesc = null,
        bool replace = true)
    {
        var url = BuildListUri(newPage, newPageSize, newSearch, newHairdresserId, newYear, newMonth, newSortBy, newDesc);
        Nav.NavigateTo(url, replace: replace);
    }

    private async Task LoadAsync()
    {
        isLoading = true;

        try
        {
            var req = new HairdresserPagedRequest
            {
                Page = page,
                PageSize = pageSize,
                Search = string.IsNullOrWhiteSpace(search) ? null : search.Trim(),
                SortBy = sortBy,
                Desc = desc,
                Year = year,
                Month = month,
                HairdresserId = isAdmin ? hairdresserId : null
            };

            model = await TimeOffService.GetAllAsync(req, CancellationToken.None);
            page = model.Page;
            pageSize = model.PageSize;
        }
        catch (ApiRequestException ex)
        {
            MessageService.ShowError(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task ApplyFiltersAsync()
    {
        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    private Task ToggleSortAsync()
    {
        NavigateToState(newPage: 1, newDesc: !desc, replace: true);
        return Task.CompletedTask;
    }

    private Task PrevPageAsync()
    {
        if (!model.CanGoPrevious)
            return Task.CompletedTask;

        NavigateToState(newPage: Math.Max(1, page - 1), replace: true);
        return Task.CompletedTask;
    }

    private Task NextPageAsync()
    {
        if (!model.CanGoNext)
            return Task.CompletedTask;

        NavigateToState(newPage: page + 1, replace: true);
        return Task.CompletedTask;
    }

    private Task ClearSearchAsync()
    {
        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = null;

        search = "";
        NavigateToState(newPage: 1, newSearch: null, replace: true);
        return Task.CompletedTask;
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? "";
        search = newValue;
        page = 1;

        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = new CancellationTokenSource();
        var token = searchCts.Token;

        try
        {
            await Task.Delay(350, token);
            if (token.IsCancellationRequested)
                return;

            var snapshot = newValue;

            NavigateToState(
                newPage: 1,
                newSearch: string.IsNullOrWhiteSpace(snapshot) ? null : snapshot,
                replace: true);
        }
        catch (TaskCanceledException)
        {
        }
    }

    private Task OnFiltersChangedAsync()
    {
        if (year is null)
            month = null;

        NavigateToState(newPage: 1, replace: true);
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        if (locationSubscribed)
        {
            locationSubscribed = false;
            Nav.LocationChanged -= OnLocationChanged;
        }

        searchCts?.Cancel();
        searchCts?.Dispose();
        searchCts = null;
    }
}