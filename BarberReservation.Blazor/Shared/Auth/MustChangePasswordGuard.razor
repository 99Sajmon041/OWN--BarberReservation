@using BarberReservation.Blazor.Auth

@inject NavigationManager Nav
@inject AuthState AuthState

@implements IDisposable

@if (_allowed)
{
    @ChildContent
}
else
{
    <div class="stack-top">
        <div class="card card-md center">
            <div class="muted">Přesměrovávám…</div>
        </div>
    </div>
}

@code {
    [Parameter, EditorRequired] public RenderFragment ChildContent { get; set; } = default!;

    private bool _allowed;
    private bool _disposed;

    private static readonly HashSet<string> AllowedPaths = new(StringComparer.OrdinalIgnoreCase)
    {
        "/login",
        "/change-password"
    };

    protected override void OnInitialized()
    {
        AuthState.OnChange += OnAuthChanged;
        Evaluate();
    }

    protected override void OnParametersSet()
    {
        Evaluate();
    }

    public void Dispose()
    {
        _disposed = true;
        AuthState.OnChange -= OnAuthChanged;
    }

    private void OnAuthChanged()
    {
        if (_disposed) return;
        try
        {
            _ = InvokeAsync(() =>
            {
                if (_disposed) return;
                Evaluate();
                StateHasChanged();
            });
        }
        catch
        {
        }
    }

    private void Evaluate()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var path = "/" + rel.Trim('/');
        if (path == "/")
            path = "/";

        if (!AuthState.IsAuthenticated || !AuthState.MustChangePassword)
        {
            _allowed = true;
            return;
        }

        _allowed = AllowedPaths.Contains(path);

        if (!_allowed)
            Nav.NavigateTo("/change-password", replace: true);
    }
}
